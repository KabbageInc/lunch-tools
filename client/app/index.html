<!DOCTYPE html>
<html>
<head>
  <title>Lunch Translator</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body ng-app="myApp" ng-controller="translationController">

  <div class="container">

    <div class="row">
      <h2>Translations</h2>
    </div>

    <div class="row">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Search String</th>
            <th>Replacement String</th>
            <th>
              <span class="pull-right">
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#editModal" ng-click="edit();"><i class="fa fa-plus-circle fa-fw"></i>New Translation</button>
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="translation in translations | orderBy: 'target'">
            <td>{{ translation.target }}</td>
            <td>{{ translation.replacement }}</td>
            <td>
              <span class="pull-right">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editModal" ng-click="edit(translation._id)"><i class="fa fa-pencil fa-fw"></i>Edit</button>
                <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal" ng-click="edit(translation._id)"><i class="fa fa-remove fa-fw"></i>Delete</button>
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="modal" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="editModalLabel">Edit Translation</h4>
          </div>
          <div class="modal-body">
            <div class="text-danger bg-danger" ng-if="error"><i class="fa fa-warning fa-fw"></i>{{ error }}</div>
            <form>
              <input type="hidden" ng-model="_id"/>
              <div class="form-group">
                <label for="searchInput">Search String:</label>
                <input type="text" ng-model="target" id="searchInput" class="form-control"/>
                <em>search string is a case-insensitive javascript regular expression</em>
              </div>
              <div class="form-group">
                <label for="replacementInput">Replacement String:</label>
                <input type="text" ng-model="replacement" id="replacementInput" class="form-control"/>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-ban fa-fw"></i>Cancel</button>
            <button type="button" class="btn btn-primary" ng-click="save();"><i class="fa fa-save fa-fw"></i>Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="deleteModalLabel">Delete Translation</h4>
          </div>
          <div class="text-danger bg-danger" ng-if="error"><i class="fa fa-warning fa-fw"></i>{{ error }}</div>
          <div class="modal-body">
            Are you sure you want to delete the translation "{{ target }}" => "{{ replacement }}" ?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-ban fa-fw"></i>Cancel</button>
            <button type="button" class="btn btn-danger" ng-click="delete(_id);"><i class="fa fa-remove fa-fw"></i>Delete</a>
          </div>
        </div>
      </div>
    </div>

  </div>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
<script type="text/javascript">
angular.module('myApp', []).controller('translationController', function($scope,$http) {

  $scope.edit = function(id) {
      if (id) {
        $http.get('translations/' + id).success(
          function(response) {
            $scope._id = response[0]._id;
            $scope.target = response[0].target;
            $scope.replacement = response[0].replacement;
            $scope.error = null;
          });
      } else {
        $scope._id = null;
        $scope.target = '';
        $scope.replacement = '';
        $scope.error = null;
      }
  };

  $scope.save = function() {
    var verb;
    var url = 'translations';

    if ($scope._id) {
      verb = 'PUT';
      url = url + '/' + $scope._id
    }
    else {
      verb = 'POST';
    }

    $http({
      url: url,
      method: verb,
      data: {
        target: $scope.target,
        replacement: $scope.replacement
       }
    }).success(function(data, status, headers, config) {
      $('#editModal').modal('hide');
      $scope.refresh();
    }).error(function(data, status, headers, config) {
      $scope.handleAjaxError(data, status, headers, config);
    });
  };

  $scope.delete = function(id) {
    $http.delete('translations/' + id)
      .success(function(data, status, headers, config) {
        $('#deleteModal').modal('hide');
        $scope.refresh();
      })
      .error(function(data, status, headers, config) {
        $scope.handleAjaxError(data, status, headers, config);
      });
  };

  $scope.refresh = function() {
    $http.get('translations').success(
      function(data, status, headers, config) {
        $scope.translations = data;
      });
  };

  $scope.handleAjaxError = function(data, status, headers, config) {
      $scope.error = 'HTTP ' + status.toString();
      if (data) {
        $scope.error += ' ' + data.eval().toString();
      }
  }

  $scope.refresh();
});
</script>

</html>
